import{l as D}from"./lodash.bce5b897.js";import{u as b,b5 as L,a as I,d as E,at as M,w as P,e as S,ba as w,c as d}from"./index.536c7d72.js";import{s as C}from"./service.4ca56d82.js";import{v as V,u as B,c as j}from"./index.6f5ae728.js";import{M as A}from"./index.4d9d5980.js";import{F as J,g as T}from"./get-elements-by-json.eedeb8ee.js";import{N as x}from"./Input.4b8b409e.js";import{a as k}from"./Select.eddb521d.js";import"./index.eb38a2cf.js";import"./Button.9dd5ee3c.js";import"./is-browser.f4bc45cf.js";import"./use-rtl.b3456902.js";import"./resolve-slot.12a336d2.js";import"./keysOf.10525521.js";import"./Card.1fac8dc8.js";import"./index.7a579f81.js";import"./index.8209174c.js";import"./flatten.f4456e1c.js";import"./Scrollbar.7c2bcabe.js";import"./fade-in.cssr.ef9eaee7.js";import"./VResizeObserver.0aad584a.js";import"./fade-in-scale-up.cssr.1167eea7.js";import"./utils.ba7f47bf.js";import"./Space.8c5cfc39.js";import"./get-slot.7f666ba0.js";import"./Form.b918a62f.js";import"./FormItem.67716b88.js";import"./format-length.a0cbed4d.js";import"./Grid.f7dd02c2.js";import"./next-frame-once.e5ee25e8.js";import"./Spin.5bd91cff.js";import"./use-compitable.7f10f89e.js";import"./Radio.8f1c774c.js";import"./RadioGroup.5a44255f.js";import"./index.ebf19dc1.js";import"./DeleteOutlined.0c0bc8fc.js";import"./Switch.57a995f1.js";import"./InputNumber.1f688029.js";import"./use-locale.31127f4e.js";import"./Add.4fb6bf29.js";import"./Checkbox.9b98fe51.js";import"./TreeSelect.c15d3653.js";import"./Selection.2ed26059.js";import"./Popover.374e8a7f.js";import"./Suffix.4fa63b0d.js";function W(n){return C({url:"/ui-plugins/query-by-type",method:"get",params:n})}function $(n){return C({url:`/ui-plugins/${n}`,method:"get"})}function z(){const{t:n}=b(),s={instanceName:"",pluginDefineId:null},e=L({detailFormRef:I(),detailForm:{...s},uiPlugins:[],pluginsLoading:!1,json:[]}),r={model:e.detailForm,requireMarkPlacement:"left",labelPlacement:"left",labelWidth:180,rules:{instanceName:{trigger:"input",required:!0,message:n("security.alarm_instance.alarm_instance_name_tips")},pluginDefineId:{trigger:["blur","change"],required:!0,validator(i,l){if(!l&&l!==0)return new Error(n("security.alarm_instance.select_plugin_tips"))}}}},a=async()=>{if(!e.pluginsLoading){e.pluginsLoading=!0;try{const i=await W({pluginType:"ALERT"});e.uiPlugins=i.map(l=>({label:l.pluginName,value:l.id})),e.pluginsLoading=!1}catch{e.pluginsLoading=!1}}};return{meta:r,state:e,setDetail:i=>{e.detailForm.instanceName=i.instanceName,e.detailForm.pluginDefineId=i.pluginDefineId,i.pluginInstanceParams&&(e.json=JSON.parse(i.pluginInstanceParams))},initForm:()=>{a()},resetForm:()=>{e.detailFormRef.resetValues({...s}),e.json=[]},getFormValues:()=>e.detailForm,changePlugin:async i=>{if(e.pluginsLoading)return;e.pluginsLoading=!0,e.detailForm.pluginDefineId=i;const{pluginParams:l}=await $(i);l&&(e.json=JSON.parse(l)),e.pluginsLoading=!1}}}function G(n){const s=L({saving:!1,loading:!1}),e=(a,o={})=>(a==null||a.forEach(t=>{const u=D.exports.isFunction(t)?t():t;u.value=o[u.field]}),JSON.stringify(a));return{status:s,createOrUpdate:async(a,o)=>{const t=n();if(s.saving)return!1;s.saving=!0;try{return(a==null?void 0:a.instanceName)!==t.instanceName&&await V({alertInstanceName:t.instanceName}),a!=null&&a.id?await B({alertPluginInstanceId:t.pluginDefineId,instanceName:t.instanceName,pluginInstanceParams:e(o,t)},a.id):await j({instanceName:t.instanceName,pluginDefineId:t.pluginDefineId,pluginInstanceParams:e(o,t)}),s.saving=!1,!0}catch{return s.saving=!1,!1}}}}const H={show:{type:Boolean,default:!1},currentRecord:{type:Object,default:{}}},Je=E({name:"DetailModal",props:H,emits:["cancel","update"],setup(n,s){var _;const{t:e}=b(),r=I({}),a=I([]),{meta:o,state:t,setDetail:u,initForm:g,resetForm:c,getFormValues:i,changePlugin:l}=z(),{status:f,createOrUpdate:y}=G(i),m=()=>{c(),r.value={},a.value=[],s.emit("cancel")},p=async()=>{await t.detailFormRef.validate(),await y(n.currentRecord,t.json)&&(m(),s.emit("update"))},U=l,O=(_=M())==null?void 0:_.appContext.config.globalProperties.trim;return P(()=>n.show,async()=>{n.show&&n.currentRecord&&u(n.currentRecord)}),P(()=>t.json,()=>{var v;if(!((v=t.json)!=null&&v.length))return;t.json.forEach(h=>{const N=D.exports.isFunction(h)?h():h;N.name=e("security.alarm_instance."+N.field)});const{rules:F,elements:q}=T(t.json,t.detailForm);r.value=F,a.value=q}),S(()=>{g()}),{t:e,...w(t),...w(f),meta:o,rules:r,elements:a,onChangePlugin:U,onSubmit:p,onCancel:m,trim:O}},render(n){const{show:s,t:e,meta:r,rules:a,elements:o,detailForm:t,uiPlugins:u,pluginsLoading:g,loading:c,saving:i,onChangePlugin:l,onCancel:f,onSubmit:y}=this,{currentRecord:m}=n;return d(A,{show:s,title:e(m!=null&&m.id?"security.alarm_instance.edit_alarm_instance":"security.alarm_instance.create_alarm_instance"),onConfirm:y,confirmLoading:i||c,onCancel:f},{default:()=>d(J,{ref:"detailFormRef",loading:c||g,meta:{...r,rules:{...r.rules,...a},elements:[{path:"instanceName",label:e("security.alarm_instance.alarm_instance_name"),widget:d(x,{allowInput:this.trim,value:t.instanceName,"onUpdate:value":p=>t.instanceName=p,placeholder:e("security.alarm_instance.alarm_instance_name_tips")},null)},{path:"pluginDefineId",label:e("security.alarm_instance.select_plugin"),widget:d(k,{value:t.pluginDefineId,"onUpdate:value":p=>t.pluginDefineId=p,options:u,disabled:!!(m!=null&&m.id),placeholder:e("security.alarm_instance.select_plugin_tips"),"on-update:value":l},null)},...o]},layout:{cols:24}},null)})}});export{Je as default};
