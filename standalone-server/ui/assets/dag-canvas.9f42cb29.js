import{S as T}from"./dag.module.c7fce5f9.js";import{G as v}from"./track.f1da8f9b.js";import{a as y,X as w,N as S,E as C,b as O,c as x,P as M,d as b,e as R,f as I,g as P,h as H}from"./dag-config.e2eb20b1.js";import{l as G,_ as o}from"./lodash.bce5b897.js";import{a as z}from"./index.990798b2.js";import F from"./dag-context-menu.eb822e2c.js";import{a as E,e as k,d as K,A as _,c as L}from"./index.536c7d72.js";import"./gForce.6c6bb633.js";import"./service.4ca56d82.js";import"./dag-node-status.53d6d801.js";import"./task-node.c5365e5f.js";import"./toNumber.c47a71ca.js";import"./Popover.374e8a7f.js";import"./index.8209174c.js";import"./flatten.f4456e1c.js";import"./Scrollbar.7c2bcabe.js";import"./fade-in.cssr.ef9eaee7.js";import"./VResizeObserver.0aad584a.js";import"./utils.ba7f47bf.js";import"./format-length.a0cbed4d.js";import"./resolve-slot.12a336d2.js";import"./use-compitable.7f10f89e.js";import"./next-frame-once.e5ee25e8.js";import"./debounce.8aa2d6ba.js";import"./index.d67d1729.js";import"./common.cc1e0c6c.js";import"./SettingOutlined.06d5d07d.js";import"./PauseCircleOutlined.a11f5c7d.js";import"./CloseCircleOutlined.14b6a996.js";import"./CheckCircleOutlined.4f0aee70.js";import"./EditOutlined.57b65af3.js";import"./index.9c0cbe29.js";import"./Button.9dd5ee3c.js";import"./is-browser.f4bc45cf.js";import"./use-rtl.b3456902.js";import"./Icon.36d6d904.js";import"./Spin.5bd91cff.js";import"./index.7a579f81.js";import"./Tooltip.2dc588a0.js";function V(N){const{readonly:n,graph:r}=N,p=E(),g=E(),u=E();function m(){return v.registerNodeTool("contextmenu",F,!0),new v({container:p.value,selecting:{enabled:!0,multiple:!0,rubberband:!0,rubberEdge:!0,movable:!0,showNodeSelectionBox:!1},scaling:{min:.2,max:2},mousewheel:{enabled:!0,modifiers:["ctrl","meta"]},scroller:!0,grid:{size:10,visible:!0},snapline:!0,minimap:{enabled:!0,container:g.value,scalable:!0,width:250,height:150},interacting:{edgeLabelMovable:!1,nodeMovable:!n.value,magnetConnectable:!n.value},connecting:{allowMulti:!1,allowBlank:!1,allowLoop:!1,allowEdge:!1,allowNode:!0,allowPort:!1,highlight:!0,createEdge(){var t;return(t=r.value)==null?void 0:t.createEdge({shape:y})},validateConnection(t){var i;const{sourceCell:a,targetCell:s}=t;if(a&&s&&a.isNode()&&s.isNode()){const c=a.getData();if(!c||c.taskType!=="CONDITIONS")return!0;const D=(i=r.value)==null?void 0:i.getConnectedEdges(a);if(!D||D.length<2)return!0;let d=0;return!D.some(f=>(f.getSourceCellId()===a.id&&d++,d>2))}return!0},validateEdge({edge:t}){var i,c;const a=(i=t.getSourceNode())==null?void 0:i.getData(),s=(c=t.getTargetNode())==null?void 0:c.getData();return t==null||t.setAttrs({line:{strokeDasharray:a.taskExecuteType==="STREAM"||s.taskExecuteType==="STREAM"?"5 5":"none"}}),!0}},highlighting:{nodeAvailable:{name:"className",args:{className:"available"}},magnetAvailable:{name:"className",args:{className:"available"}},magnetAdsorbed:{name:"className",args:{className:"adsorbed"}}}})}k(()=>{r.value=m(),r.value.on("edge:connected",({isNew:t,edge:a})=>{if(t){const s=a.getSourceNode();a.setSource(s)}}),r.value.on("node:mouseenter",({node:t})=>{const a=t.getData().taskName,i=t.getMarkup().filter(c=>c.tagName==="foreignObject")[0];t.addTools({name:"button",args:{markup:[{tagName:"text",textContent:a,attrs:{fill:"#868686","font-size":16,"text-anchor":"center"}}],x:0,y:0,offset:{x:0,y:i?-28:-10}}})}),r.value.on("node:mouseleave",({node:t})=>{t.removeTool("button")})});const e=G.exports.debounce(()=>{var t;if(u.value){const a=u.value.offsetWidth,s=u.value.offsetHeight;(t=r.value)==null||t.resize(a,s)}},200);z(u,e);function l(){v.unregisterNode(w),v.unregisterEdge(y),v.registerNode(w,{...S}),v.registerEdge(y,{...C})}return k(()=>{l()}),{graph:r,paper:p,minimap:g,container:u}}function X(N){const{graph:n}=N,r=E(),p=e=>e?e.toLocaleLowerCase()==="em"||e.toLocaleLowerCase()==="body":!1;function g(e){var s;const l=e===r.value,t=(s=n.value)==null?void 0:s.isSelected(e);let a=null;l?a=o.merge(o.cloneDeep(C),O):t?a=o.merge(o.cloneDeep(C),x):a=o.cloneDeep(C),e.setAttrs(a.attrs),e.setLabels([{...o.merge({attrs:o.cloneDeep(a.defaultLabel.attrs)})}])}function u(e){var A;const l=e===r.value,t=(A=n.value)==null?void 0:A.isSelected(e),a=o.cloneDeep(M.groups[b].attrs),s=o.cloneDeep(R.groups[b].attrs),i=o.cloneDeep(I.groups[b].attrs),c=o.merge(o.cloneDeep(S.attrs),P.attrs),D=o.merge(o.cloneDeep(S.attrs),H.attrs);let d=null,f=null,h=null;l||t?(d=`/dolphinscheduler/ui/images/task-icons/${(e.data.taskType!=="FLINK_STREAM"?e.data.taskType:"FLINK").toLocaleLowerCase()}_hover.png`,l?(f=c,h=o.merge(i,a)):(f=D,h=o.merge(i,s))):(d=`/dolphinscheduler/ui/images/task-icons/${(e.data.taskType!=="FLINK_STREAM"?e.data.taskType:"FLINK").toLocaleLowerCase()}.png`,f=S.attrs,h=i),e.setAttrByPath("image/xlink:href",d),e.setAttrs(f),e.setPortProp(b,"attrs",h)}function m(e){e.isEdge()?g(e):e.isNode()&&u(e)}return k(()=>{n.value&&(n.value.on("cell:mouseenter",e=>{const{cell:l,e:t}=e;p(t.target.tagName)||(r.value=l,m(l))}),n.value.on("cell:mouseleave",({cell:e})=>{r.value=void 0,m(e)}),n.value.on("cell:selected",({cell:e})=>{m(e)}),n.value.on("cell:unselected",({cell:e})=>{m(e)}))}),{hoverCell:r}}const we=K({name:"workflow-dag-canvas",emits:["drop"],setup(N,n){const r=_("readonly",E(!1)),p=_("graph",E()),{paper:g,minimap:u,container:m}=V({readonly:r,graph:p});X({graph:p});const e=l=>{l.preventDefault()};return()=>L("div",{ref:m,class:[T.canvas,"dag-container"],onDrop:l=>{n.emit("drop",l)},onDragenter:e,onDragover:e,onDragleave:e},[L("div",{ref:g,class:T.paper},null),L("div",{ref:u,class:T.minimap},null)])}});export{we as default};
