import{u as x,bJ as V,bq as E,b5 as q,a as l,t as r,d as O,at as H,e as W,w as z,ba as A,c as i}from"./index.536c7d72.js";import{u as D}from"./index.990798b2.js";import{A as B,d as F,f as G,q as J}from"./index.bf50bc28.js";import{B as K}from"./index.eb38a2cf.js";import{r as L,p as P,t as X,s as Y}from"./common.cc1e0c6c.js";import{D as Q,C as c,c as Z}from"./column-width-config.7df9c412.js";import{C as $}from"./CheckCircleOutlined.4f0aee70.js";import{D as ee}from"./DownloadOutlined.e576ca2a.js";import{f as w}from"./index.9c0cbe29.js";import{N as te}from"./Ellipsis.b0d6a040.js";import{N as C}from"./Tooltip.2dc588a0.js";import{N as T}from"./Button.9dd5ee3c.js";import{N}from"./Icon.36d6d904.js";import{N as k}from"./Space.8c5cfc39.js";import{N as ae}from"./Spin.5bd91cff.js";import{L as oe,q as se}from"./index.940c2a82.js";import{C as _}from"./index.67b00418.js";import{S as re}from"./SearchOutlined.b0711796.js";import{N as R}from"./Input.4b8b409e.js";import{a as ne}from"./Select.eddb521d.js";import{N as ie}from"./DatePicker.9d2907ba.js";import{N as le,a as ce}from"./DataTable.4d10e01f.js";import"./service.4ca56d82.js";import"./lodash.bce5b897.js";import"./SettingOutlined.06d5d07d.js";import"./PauseCircleOutlined.a11f5c7d.js";import"./CloseCircleOutlined.14b6a996.js";import"./EditOutlined.57b65af3.js";import"./Popover.374e8a7f.js";import"./index.8209174c.js";import"./flatten.f4456e1c.js";import"./Scrollbar.7c2bcabe.js";import"./fade-in.cssr.ef9eaee7.js";import"./VResizeObserver.0aad584a.js";import"./utils.ba7f47bf.js";import"./format-length.a0cbed4d.js";import"./resolve-slot.12a336d2.js";import"./use-compitable.7f10f89e.js";import"./next-frame-once.e5ee25e8.js";import"./is-browser.f4bc45cf.js";import"./use-rtl.b3456902.js";import"./get-slot.7f666ba0.js";import"./index.7a579f81.js";import"./index.4d9d5980.js";import"./keysOf.10525521.js";import"./Card.1fac8dc8.js";import"./fade-in-scale-up.cssr.1167eea7.js";import"./SyncOutlined.60307d76.js";import"./FullscreenOutlined.764420ff.js";import"./use-locale.31127f4e.js";import"./throttle.25c0ae05.js";import"./debounce.8aa2d6ba.js";import"./toNumber.c47a71ca.js";import"./Suffix.4fa63b0d.js";import"./Selection.2ed26059.js";import"./use-keyboard.3c40c702.js";import"./Forward.5223a2c3.js";import"./ArrowDown.e4a7e0d5.js";import"./Checkbox.9b98fe51.js";import"./RadioGroup.5a44255f.js";import"./Radio.8f1c774c.js";import"./Dropdown.8c20a4f5.js";import"./ChevronRight.ffdb37b1.js";function pe(){const{t}=x(),e=V(),p=E(),m=Number(e.params.projectCode),u=Number(e.params.processInstanceId),h=e.params.taskName,a=q({columns:[],tableWidth:Q,tableData:[],page:l(1),pageSize:l(10),searchVal:l(h||null),processInstanceId:l(u||null),host:l(null),stateType:l(null),datePickerRange:l(null),executorName:l(null),processInstanceName:l(null),totalPage:l(1),showModalRef:l(!1),row:{},loadingRef:l(!1),logRef:"",logLoadingRef:l(!0),skipLineNum:l(0),limit:l(1e3)}),n=s=>{s.columns=[{title:"#",key:"index",render:(o,f)=>f+1,...c.index},{title:t("project.task.task_name"),key:"name",...c.name},{title:t("project.task.workflow_instance"),key:"processInstanceName",...c.linkName,render:o=>r(K,{onClick:()=>void p.push({name:"workflow-instance-detail",params:{id:o.processInstanceId},query:{code:m}})},{default:()=>r(te,c.linkEllipsis,()=>o.processInstanceName)})},{title:t("project.task.executor"),key:"executorName",...c.name},{title:t("project.task.node_type"),key:"taskType",...c.type},{title:t("project.task.state"),key:"state",...c.state,render:o=>me(o.state,t)},{title:t("project.task.submit_time"),...c.time,key:"submitTime",render:o=>L(o.submitTime)},{title:t("project.task.start_time"),...c.time,key:"startTime",render:o=>L(o.startTime)},{title:t("project.task.end_time"),...c.time,key:"endTime",render:o=>L(o.endTime)},{title:t("project.task.duration"),key:"duration",...c.duration,render:o=>r("span",null,o.duration?o.duration:"-")},{title:t("project.task.retry_count"),key:"retryTimes",...c.times},{title:t("project.task.dry_run_flag"),key:"dryRun",...c.dryRun,render:o=>o.dryRun===1?"YES":"NO"},{title:t("project.task.host"),key:"host",...c.name,render:o=>o.host||"-"},{title:t("project.task.operation"),key:"operation",...c.operation(3),render(o){return r(k,null,{default:()=>[r(C,{},{trigger:()=>r(T,{tag:"div",circle:!0,type:"info",size:"small",disabled:!(o.state==="FAILURE"||o.state==="NEED_FAULT_TOLERANCE"||o.state==="KILL"),onClick:()=>{b(o)}},{icon:()=>r(N,null,{default:()=>r($)})}),default:()=>t("project.task.forced_success")}),r(C,{},{trigger:()=>r(T,{circle:!0,type:"info",size:"small",disabled:!o.host,onClick:()=>S(o)},{icon:()=>r(N,null,{default:()=>r(B)})}),default:()=>t("project.task.view_log")}),r(C,{},{trigger:()=>r(T,{circle:!0,type:"info",size:"small",onClick:()=>F(o.id)},{icon:()=>r(N,null,{default:()=>r(ee)})}),default:()=>t("project.task.download_log")})]})}}],s.tableWidth&&(s.tableWidth=Z(s.columns))},S=s=>{a.showModalRef=!0,a.row=s},b=s=>{G({id:s.id},{projectCode:m}).then(()=>{y({pageSize:a.pageSize,pageNo:a.tableData.length===1&&a.page>1?a.page-1:a.page,searchVal:a.searchVal,processInstanceId:a.processInstanceId,host:a.host,stateType:a.stateType,datePickerRange:a.datePickerRange,executorName:a.executorName,processInstanceName:a.processInstanceName})})},y=s=>{if(a.loadingRef)return;a.loadingRef=!0;const o={pageSize:s.pageSize,pageNo:s.pageNo,searchVal:s.searchVal,processInstanceId:s.processInstanceId,host:s.host,stateType:s.stateType,startDate:s.datePickerRange?w(P(s.datePickerRange[0]),"yyyy-MM-dd HH:mm:ss"):"",endDate:s.datePickerRange?w(P(s.datePickerRange[1]),"yyyy-MM-dd HH:mm:ss"):"",executorName:s.executorName,processInstanceName:s.processInstanceName},{state:f}=D(J(o,{projectCode:m}).then(d=>{a.tableData=d.totalList,a.totalPage=d.totalPage,a.loadingRef=!1}),{});return f};return{t,variables:a,getTableData:y,createColumns:n}}function me(t,e){if(!t)return"";const p=X(e)[t],m=r(N,{color:p.color,class:p.classNames,style:{display:"flex"},size:20},()=>r(p.icon));return r(C,null,{trigger:()=>p.isSpin?r(ae,{size:20},{icon:()=>m}):m,default:()=>p.desc})}const Rt=O({name:"task-instance",setup(){var j;const{t,variables:e,getTableData:p,createColumns:m}=pe(),u=()=>{p({pageSize:e.pageSize,pageNo:e.page,searchVal:e.searchVal,processInstanceId:e.processInstanceId,host:e.host,stateType:e.stateType,datePickerRange:e.datePickerRange,executorName:e.executorName,processInstanceName:e.processInstanceName})},h=()=>{e.page=1,u()},a=()=>{e.page=1,u()},n=()=>{e.searchVal="",a()},S=()=>{e.processInstanceName=null,a()},b=()=>{e.executorName=null,a()},y=()=>{e.host=null,a()},s=()=>{e.stateType=null,a()},o=()=>{e.datePickerRange=null,a()},f=()=>{e.showModalRef=!1},d=I=>{const{state:U}=D(se({taskInstanceId:Number(I.id),limit:e.limit,skipLineNum:e.skipLineNum}).then(g=>{g!=null&&g.message?(e.logRef+=g.message,e.limit+=1e3,e.skipLineNum+=g.lineNum,d(I)):e.logLoadingRef=!1}),{});return U},v=I=>{e.logRef="",e.limit=1e3,e.skipLineNum=0,d(I)},M=(j=H())==null?void 0:j.appContext.config.globalProperties.trim;return W(()=>{m(e),u()}),z(x().locale,()=>{m(e)}),z(()=>e.showModalRef,()=>{e.showModalRef?d(e.row):(e.row={},e.logRef="",e.logLoadingRef=!0,e.skipLineNum=0,e.limit=1e3)}),{t,...A(e),requestTableData:u,onUpdatePageSize:h,onSearch:a,onClearSearchTaskName:n,onClearSearchProcessInstanceName:S,onClearSearchExecutorName:b,onClearSearchHost:y,onClearSearchStateType:s,onClearSearchTime:o,onConfirmModal:f,refreshLogs:v,trim:M}},render(){const{t,requestTableData:e,onUpdatePageSize:p,onSearch:m,onConfirmModal:u,loadingRef:h,refreshLogs:a}=this;return i(k,{vertical:!0},{default:()=>[i(_,null,{default:()=>[i(k,{justify:"end",wrap:!1},{default:()=>[i(R,{allowInput:this.trim,value:this.searchVal,"onUpdate:value":n=>this.searchVal=n,size:"small",placeholder:t("project.task.task_name"),clearable:!0,onClear:this.onClearSearchTaskName},null),i(R,{allowInput:this.trim,value:this.processInstanceName,"onUpdate:value":n=>this.processInstanceName=n,size:"small",placeholder:t("project.task.workflow_instance"),clearable:!0,onClear:this.onClearSearchProcessInstanceName},null),i(R,{allowInput:this.trim,value:this.executorName,"onUpdate:value":n=>this.executorName=n,size:"small",placeholder:t("project.task.executor"),clearable:!0,onClear:this.onClearSearchExecutorName},null),i(R,{allowInput:this.trim,value:this.host,"onUpdate:value":n=>this.host=n,size:"small",placeholder:t("project.task.host"),clearable:!0,onClear:this.onClearSearchHost},null),i(ne,{value:this.stateType,"onUpdate:value":n=>this.stateType=n,size:"small",options:Y(t).slice(1),placeholder:t("project.task.state"),style:{width:"180px"},clearable:!0,onClear:this.onClearSearchStateType},null),i(ie,{value:this.datePickerRange,"onUpdate:value":n=>this.datePickerRange=n,type:"datetimerange",size:"small","start-placeholder":t("project.task.start_time"),"end-placeholder":t("project.task.end_time"),clearable:!0,onClear:this.onClearSearchTime},null),i(T,{size:"small",type:"primary",onClick:m},{default:()=>[i(N,null,{default:()=>[i(re,null,null)]})]})]})]}),i(_,{title:t("project.task.batch_task")},{default:()=>[i(k,{vertical:!0},{default:()=>[i(le,{loading:h,columns:this.columns,data:this.tableData,scrollX:this.tableWidth},null),i(k,{justify:"center"},{default:()=>[i(ce,{page:this.page,"onUpdate:page":n=>this.page=n,"page-size":this.pageSize,"onUpdate:page-size":n=>this.pageSize=n,"page-count":this.totalPage,"show-size-picker":!0,"page-sizes":[10,30,50],"show-quick-jumper":!0,onUpdatePage:e,onUpdatePageSize:p},null)]})]})]}),i(oe,{showModalRef:this.showModalRef,logRef:this.logRef,row:this.row,logLoadingRef:this.logLoadingRef,onConfirmModal:u,onRefreshLogs:a},null)]})}});export{Rt as default};
